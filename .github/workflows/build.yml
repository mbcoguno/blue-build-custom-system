name: bluebuild
on:
  schedule:
    - cron:
        "00 20 * * *" # build at 20:00 UTC every day
        # (20 minutes after last ublue images start building)
  push:
    paths-ignore: # don't rebuild if only documentation has changed
      - "**.md"

  pull_request:
  workflow_dispatch: # allow manually triggering builds

concurrency:
  # only run one build at a time
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  check-upstream:
    name: Check upstream image update
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_update: ${{ steps.compare.outputs.has_update }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get image info from recipe
        id: recipe
        run: |
          BASE_IMAGE=$(yq '.["base-image"]' recipes/recipe.yml)
          IMAGE_VERSION=$(yq '.["image-version"]' recipes/recipe.yml)
          FEDORA_VERSION="${IMAGE_VERSION##*-}"
          echo "base_image=$BASE_IMAGE" >> "$GITHUB_OUTPUT"
          echo "image_version=$IMAGE_VERSION" >> "$GITHUB_OUTPUT"
          echo "fedora_version=$FEDORA_VERSION" >> "$GITHUB_OUTPUT"

      - name: Get upstream image digest
        id: upstream
        run: |
          DIGEST=$(skopeo inspect --no-tags \
            "docker://${{ steps.recipe.outputs.base_image }}:${{ steps.recipe.outputs.image_version }}" \
            | jq -r '.Digest')
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Check DNF package updates
        id: dnf-pkgs
        run: |
          FEDORA_VER="${{ steps.recipe.outputs.fedora_version }}"
          METADATA=""

          # Check COPR repos
          while IFS= read -r COPR; do
            OWNER="${COPR%%/*}"
            PROJECT="${COPR##*/}"
            URL="https://download.copr.fedorainfracloud.org/results/${OWNER}/${PROJECT}/fedora-${FEDORA_VER}-x86_64/repodata/repomd.xml"
            METADATA+=$(curl -sfL "$URL" | grep -o '<revision>[^<]*</revision>' || true)
          done < <(yq '.modules[] | select(.type == "dnf") | .repos.copr[]' recipes/recipe.yml)

          # Check repo files (local files and remote URLs)
          while IFS= read -r REPO_REF; do
            if [[ "$REPO_REF" == http* ]]; then
              BASEURL=$(curl -sfL "$REPO_REF" | grep '^baseurl=' | head -1 | cut -d= -f2-)
            else
              BASEURL=$(grep '^baseurl=' "files/dnf/$REPO_REF" | head -1 | cut -d= -f2-)
            fi
            if [ -n "$BASEURL" ]; then
              BASEURL=$(echo "$BASEURL" | sed "s/\\\$releasever/$FEDORA_VER/g; s/%OS_VERSION%/$FEDORA_VER/g")
              METADATA+=$(curl -sfL "${BASEURL}/repodata/repomd.xml" | grep -o '<revision>[^<]*</revision>' || true)
            fi
          done < <(yq '.modules[] | select(.type == "dnf") | .repos.files[]' recipes/recipe.yml)

          # Check Fedora official packages via Bodhi
          while IFS= read -r PKG; do
            UPDATE_ID=$(curl -sfL \
              "https://bodhi.fedoraproject.org/updates/?packages=${PKG}&releases=F${FEDORA_VER}&status=stable&rows_per_page=1&content_type=rpm" \
              | jq -r '.updates[0].updateid // empty' 2>/dev/null || true)
            METADATA+="${PKG}=${UPDATE_ID};"
          done < <(yq '.modules[] | select(.type == "dnf") | .install.packages[]' recipes/recipe.yml)

          HASH=$(echo "$METADATA" | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"

      - name: Check 1Password repo metadata
        id: onepassword
        run: |
          REVISION=$(curl -sfL "https://downloads.1password.com/linux/rpm/stable/x86_64/repodata/repomd.xml" \
            | grep -o '<revision>[^<]*</revision>' || true)
          HASH=$(echo "$REVISION" | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"

      - name: Restore cached state
        uses: actions/cache/restore@v4
        with:
          path: upstream-state.txt
          key: upstream-state-${{ steps.recipe.outputs.image_version }}-${{ steps.upstream.outputs.digest }}-${{ steps.dnf-pkgs.outputs.hash }}-${{ steps.onepassword.outputs.hash }}
          restore-keys: |
            upstream-state-${{ steps.recipe.outputs.image_version }}-

      - name: Compare with cached state
        id: compare
        run: |
          CURRENT="${{ steps.upstream.outputs.digest }}:${{ steps.dnf-pkgs.outputs.hash }}:${{ steps.onepassword.outputs.hash }}"
          PREVIOUS=""
          if [ -f upstream-state.txt ]; then
            PREVIOUS=$(cat upstream-state.txt)
          fi
          if [ "$PREVIOUS" = "$CURRENT" ]; then
            echo "No updates detected"
            echo "has_update=false" >> "$GITHUB_OUTPUT"
          else
            echo "Updates detected"
            echo "has_update=true" >> "$GITHUB_OUTPUT"
          fi
          echo "$CURRENT" > upstream-state.txt

      - name: Save state to cache
        if: steps.compare.outputs.has_update == 'true'
        uses: actions/cache/save@v4
        with:
          path: upstream-state.txt
          key: upstream-state-${{ steps.recipe.outputs.image_version }}-${{ steps.upstream.outputs.digest }}-${{ steps.dnf-pkgs.outputs.hash }}-${{ steps.onepassword.outputs.hash }}

  bluebuild:
    name: Build Custom Image
    needs: check-upstream
    # On schedule: only build if upstream image has been updated
    # On push/PR/workflow_dispatch: always build
    if: >-
      needs.check-upstream.outputs.has_update == 'true' ||
      github.event_name != 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      fail-fast: false # stop GH from cancelling all matrix builds if one fails
      matrix:
        recipe:
          # !! Add your recipes here
          - recipe.yml
    steps:
      # the build is fully handled by the reusable github action
      - name: Build Custom Image
        uses: blue-build/github-action@v1.11
        with:
          recipe: ${{ matrix.recipe }}
          cosign_private_key: ${{ secrets.SIGNING_SECRET }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}
          # enabled by default, disable if your image is small and you want faster builds
          maximize_build_space: true
          # need more runner space.
          build_chunked_oci: false
          rechunk_clear_plan: false
