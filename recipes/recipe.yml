---
# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json
# image will be published to ghcr.io/<user>/<name>
name: blue-build-custom-system
# description will be included in the image's metadata
description: This is my personal OS image with my favorite tools.

# the base image to build on top of (FROM) and the version tag to use
base-image: ghcr.io/ublue-os/bazzite-dx
image-version: stable # latest is also supported if you want new updates ASAP

# module configuration, executed in order
# you can include multiple instances of the same module
modules:
  - type: files
    files:
      - source: system
        destination: / # copies files/system/* (* means everything inside it) into your image's root folder /

  - type: script
    snippets:
      - "install -d -m 0755 /nix /snap"

  # Not apply after update. Manual add: `rpm-ostree kargs --append-if-missing=KEY=VALUE`
  # https://www.answeroverflow.com/m/1404867444320895136
  - type: kargs
    arch: x86_64  # only inject kernel arguments to these specific OS architectures
    kargs:
      # Help KVM using VFIO on Windows.
      - kvm.ignore_msrs=1
      - kvm.report_ignored_msrs=0
      # Disable USB autosuspend on Linux desktop using sleep.
      - usbcore.autosuspend=-1
      # Use full kernel preemption.
      - preempt=full

  - type: fonts
    fonts:
      nerd-fonts:
        - JetBrainsMono
        - Hasklig
        - CascadiaCode
        - ZedMono

  - type: bling
    install:
      - 1password

  - type: default-flatpaks
    configurations:
      - notify: false # Send notification after install/uninstall is finished (true/false)
        scope: system
        # If no repo information is specified, Flathub will be used by default
        install: # system flatpaks we want all users to have and not remove
          - app.polychromatic.controller
          - com.bitwarden.desktop
          - com.discordapp.Discord
          - com.github.k4zmu2a.spacecadetpinball
          - com.github.mtkennerly.ludusavi
          - com.hunterwittenborn.Celeste
          - com.obsproject.Studio
          - io.mpv.Mpv
          - me.proton.Mail
          - org.keepassxc.KeePassXC
          - org.libreoffice.LibreOffice
          - org.mozilla.Thunderbird
          - org.prismlauncher.PrismLauncher
          - org.sonic3air.Sonic3AIR
          # Wishlist:
          # https://github.com/flathub/flathub/pull/6775
          #
          # Branches not support in v2 because it use `flathub.org/api/v2/stats/` API.
          # - org.freedesktop.Platform.VulkanLayer.gamescope//24.08
          # - org.freedesktop.Platform.VulkanLayer.vkBasalt//24.08
          # - org.freedesktop.Platform.VulkanLayer.MangoHud//24.08
          # - org.freedesktop.Platform.VulkanLayer.OBSVkCapture//24.08
      - notify: false
        scope: user # Also add Flathub user repo.
        install:
          - com.usebottles.bottles
          - com.heroicgameslauncher.hgl

  # https://blue-build.org/blog/dnf-module/
  - type: dnf
    # https://github.com/boredsquirrel/browserscript-fedora-atomic
    repos:
      files:
        - vivaldi-x86_64.repo
        - https://openrazer.github.io/hardware:razer.repo
      keys:
        - https://repo.vivaldi.com/archive/linux_signing_key.pub
        - https://download.opensuse.org/repositories/hardware:/razer/Fedora_%OS_VERSION%/repodata/repomd.xml.key
      copr:
        - secureblue/bubblejail
        - apicalshark/fcitx5-mcbopomofo
    install:
      packages:
        - vivaldi-stable
        - bubblejail
        - openrazer-daemon
        # https://github.com/ublue-os/bazzite/issues/2996
        - fcitx5-table-extra
        - fcitx5-mcbopomofo
        - fcitx5-chewing
    optfix:
      - vivaldi

  - type: systemd
    system:
      enabled:
        - sshd.service
        - tailscaled.service
        # - force-wol.service
    user:
      enabled:
        - sunshine.service

  - type: signing # this sets up the proper policy & signing files for signed images to work fully
